---
title: "PCA_Admix"
author: "Silas Decker"
date: "2025-09-25"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir="~/projects/eco_genomics_2025/population_genomics/myresults/ANGSD/PCA_ADMIX") 
```

## R Markdown
Load Libraries for Plotting

```{r}
library(ggplot2)
library(ggpubr)
```
First Lets estimate PCA!

```{r}
# K=2: RSBS_poly_K2.cov
# K=3: RSBS_poly_K3.cov
# K=4: RSBS_poly_K4.cov
# K=5: RSBS_poly_K5.cov

COV<-as.matrix(read.table('RSBS_poly_K5.cov'))
PCA<-eigen(COV)
```
How much variance does the first eigenvalue explain 

```{r}
var<-round(PCA$values/sum(PCA$values),3)
var[1:3]



```
Scree plot of the variance explained (barplot of variance explained with excessivelt high eigenvalues )

```{r}
barplot(var, 
        xlab="Eigenvalues of the PCA", 
        ylab="Proportion of variance explained")
```

Good ole data wrangling 
Takes the names of our samples and makes them into tidy format 

```{r}
names <- read.table("RSBS_bam.list")
names <- unlist(strsplit(basename(as.character(names[,1])), split = ".sorted.rmdup.bam"))
split = strsplit(names, "_")
pops <- data.frame(names[1:113], do.call(rbind, split[1:113]))
names(pops) = c("Ind", "Pop", "Row", "Col")

data=as.data.frame(PCA$vectors)
data=data[,c(1:3)]
data= cbind(data, pops)
```
```{r}
ggscatter(data, x = "V2", y = "V3",
          color = "Pop",
          mean.point = TRUE,
          star.plot = TRUE,
          main="Red spruce-Black spruce genetic PCA") +
  theme_bw(base_size = 13, base_family = "Times") +
  labs(x = paste0("PC1: (",var[1]*100,"%)"), y = paste0("PC2: (",var[2]*100,"%)"))
```

What about admixture analysis
```{r}

# K=2 : RSBS_poly_K2.admix.2.Q
# K=3 : RSBS_poly_K3.admix.3.Q
# K=4  RSBS_poly_K4.admix.4.Q
# K=5   RSBS_poly_K5.admix.5.Q
q <- read.table("/gpfs1/home/s/m/smdecker/projects/eco_genomics_2025/population_genomics/myresults/ANGSD/PCA_ADMIX/RSBS_poly_K5.admix.5.Q", sep=" ", header=F)

K=dim(q)[2] #Find the level of K modeled

## rank order the samples according to population code
ord<-order(pops[,2])


```

Plot the admixture coefficients 
```{r}
barplot(t(q)[,ord],
        #col=cols[1:K],
        col=c("black","red"),
        space=0,border=NA,
        xlab="Populations",ylab="Admixture proportions",
        main=paste0("Red Spruce-Black Spruce Admixture: K=",K))
text(tapply(1:nrow(pops),pops[ord,2],mean),-0.05,unique(pops[ord,2]),xpd=T,cex=0.75,srt=45)
abline(v=cumsum(sapply(unique(pops[ord,2]),function(x){sum(pops[ord,2]==x)})),col=1,lwd=1.2)
```

